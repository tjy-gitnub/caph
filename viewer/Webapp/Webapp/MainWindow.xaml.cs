using Microsoft.Win32;
using System;
using System.Diagnostics;
using System.IO;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Forms;
using System.Windows.Input;
using System.Windows.Interop;
using System.Windows.Media;
using System.Windows.Media.Animation;
using System.Windows.Media.Imaging;
using Wpf.Ui.Appearance;
using Wpf.Ui.Controls;
using CefSharp;
using CefSharp.Wpf;
using System.Linq;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Threading.Tasks;

namespace Webapp
{

    public class ThemeListener : IDisposable
    {
        private const string keyPath = @"Software\Microsoft\Windows\CurrentVersion\Themes\Personalize";
        private RegistryKey registryKey;
        private IntPtr registryKeyHandle;
        private bool disposed = false;

        // Win32 API
        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern int RegOpenKeyEx(
            UIntPtr hKey,
            string subKey,
            uint options,
            int samDesired,
            out IntPtr phkResult);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern int RegNotifyChangeKeyValue(
            IntPtr hKey,
            bool watchSubtree,
            uint notifyFilter,
            IntPtr hEvent,
            bool asynchronous);

        private const int KEY_READ = 0x20019;
        private const uint REG_NOTIFY_CHANGE_LAST_SET = 0x00000004;

        public event EventHandler ThemeChanged;

        public ThemeListener()
        {
            registryKey = Registry.CurrentUser.OpenSubKey(keyPath, false);
            // 获取底层句柄
            RegOpenKeyEx((UIntPtr)0x80000001 /*HKEY_CURRENT_USER*/, keyPath, 0, KEY_READ, out registryKeyHandle);
            Task.Run(() => WatchRegistry());
        }

        private void WatchRegistry()
        {
            while (!disposed)
            {
                int result = RegNotifyChangeKeyValue(
                    registryKeyHandle,
                    false,
                    REG_NOTIFY_CHANGE_LAST_SET,
                    IntPtr.Zero,
                    false);

                if (result == 0 && !disposed)
                {
                    ThemeChanged?.Invoke(this, EventArgs.Empty);
                }
            }
        }

        public void Dispose()
        {
            disposed = true;
            registryKey?.Dispose();
            if (registryKeyHandle != IntPtr.Zero)
            {
                Marshal.Release(registryKeyHandle);
                registryKeyHandle = IntPtr.Zero;
            }
        }
    }

    public class JsInterop
    {
        public IWebBrowser browserControl { get; set; }
        public Action animateHideWindow { get; set; }
        public Action openGuideWindow { get; set; }

        public Action openAboutWindow { get; set; }

        public void OpenDevTools()
        {
            browserControl.ShowDevTools();
        }

        public void HideWindow()
        {
            animateHideWindow?.Invoke();
        }

        public void OpenGuide()
        {
            openGuideWindow?.Invoke();
        }

        public void OpenUrl(string url)
        {
            // 在默认浏览器中打开链接
            Process.Start(new ProcessStartInfo
            {
                FileName = "\"" + url + "\"",
                UseShellExecute = true
            });
        }

        public void OpenAbout()
        {
            openAboutWindow?.Invoke();
        }
    }

    public class DownloadHandler : IDownloadHandler
    {

        public bool CanDownload(IWebBrowser browserControl, IBrowser browser, string url, string suggestedFileName)
        {
            return true;
        }

        public bool OnBeforeDownload(
            IWebBrowser browserControl,
            IBrowser browser,
            DownloadItem downloadItem,
            IBeforeDownloadCallback callback)
        {
            if (callback.IsDisposed) return false;

            // 这里指定下载的文件保存路径
            string downloadPath = System.IO.Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
                downloadItem.SuggestedFileName);

            // 第二个参数 showDialog=false 表示不弹窗，自动下载
            callback.Continue(downloadPath, showDialog: true);
            return true;
        }

        public void OnDownloadUpdated(
            IWebBrowser browserControl,
            IBrowser browser,
            DownloadItem downloadItem,
            IDownloadItemCallback callback)
        {
            if (downloadItem.IsComplete)
            {
                Process.Start("explorer.exe", $"/select,\"{downloadItem.FullPath}\"");
            }
        }
    }
    public partial class MainWindow
    {
        private NotifyIcon _trayIcon;
        private const double RightMargin = 20; // gap from right edge
        private const double TopMargin = 20;   // gap from top
        private const double BottomMargin = 20; // gap from bottom
        private const double WINDOW_WIDTH = 400; // fixed window width
        private bool _isHidden = false;

        // animation state
        private bool _isAnimating = false;
        private Stopwatch _animWatch;
        private double _animFrom;
        private double _animTo;
        private double _animDurationMs = 300.0;

        JsInterop jsInterop = new JsInterop();
        private Process _childProcess;
        public MainWindow()
        {
            CefSettings setting = new CefSettings();
            setting.CefCommandLineArgs.Add("disable-web-security", "1");
            Cef.Initialize(setting);

            InitializeComponent();
            
            // enforce fixed width and disable resizing
            this.Width = WINDOW_WIDTH;
            this.MinWidth = this.MaxWidth = WINDOW_WIDTH;
            this.ResizeMode = ResizeMode.NoResize;

            Loaded += MainWindow_Loaded;
            SourceInitialized += MainWindow_SourceInitialized;

            //HideButton.Click += HideButton_Click;
            Loaded += (sender, args) =>
            {
                Wpf.Ui.Appearance.SystemThemeWatcher.Watch(
                    this,                                    // Window class
                    Wpf.Ui.Controls.WindowBackdropType.Acrylic, // Background type
                    false                                     // Whether to change accents automatically
                );
            };
            SystemThemeWatcher.Watch(this);

            ThemeListener listener = new ThemeListener();
            listener.ThemeChanged += handle_ThemeChanged;
            handle_ThemeChanged(this, EventArgs.Empty);
            // Initialize tray
            InitTray();

            cefb.JavascriptObjectRepository.Settings.LegacyBindingEnabled = true;
            jsInterop.browserControl = cefb;
            jsInterop.animateHideWindow = () =>
            {
                if (_isHidden) return;
                this.Dispatcher.Invoke(() =>
                {
                    AnimateHide(true);
                });
            };
            jsInterop.openGuideWindow = () =>
            {
                this.Dispatcher.Invoke(() =>
                {
                    var guideWindow = new Guide();
                    guideWindow.Show();
                });
            };
            jsInterop.openAboutWindow = () =>
            {
                this.Dispatcher.Invoke(() =>
                {
                    var aboutWindow = new About();
                    aboutWindow.ShowDialog();
                });
            };
            cefb.JavascriptObjectRepository.Register("cefBridge", jsInterop, isAsync: true, options: BindingOptions.DefaultBinder);
            cefb.DownloadHandler = new DownloadHandler();

            cefb.LoadError += Browser_LoadError; 

            cefb.LoadHtml($@"<!DOCTYPE html>
<html>
<head>
    <title>Caph</title>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
</head>

<body>
    <style>
        body{{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            margin: 0;
            box-sizing: border-box;
            --primary: #005fba;
            --text: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }}

        @media(prefers-color-scheme: dark){{
            body{{
                --primary: #61ccff;
                --text: #fff;
            }}
        }}
        
        *{{
            user-select: none;
            cursor: default;
        }}

        #logo{{
            width: 35vw;
            min-width: 90px;
            max-width: 150px;
        }}

        #caph{{
            font-size: 32px;
            color: var(--text);
            margin: 10px 0 15px 0;
        }}
        
        loading {{
            display: flex;
            height: 80px;
            width: 100%;
            align-items: center;
            justify-content: center;
        }}

        loading>svg>circle:last-child {{
            stroke: var(--primary);
            fill: none;
            stroke-width: 2px;
            stroke-linecap: round;
            animation: spin-infinite 2s linear 0s infinite normal none running;
            transform-origin: 50% 50%;
            transition: all .2s ease-in-out 0s;
        }}

        loading>svg {{
            background-color: #00000000;
            border-radius: 50%;
        }}

        @keyframes spin-infinite {{
            0% {{
                stroke-dasharray: .01px, 43.97px;
                transform: rotate(0deg)
            }}

            50% {{
                stroke-dasharray: 21.99px, 21.99px;
                transform: rotate(450deg)
            }}

            to {{
                stroke-dasharray: .01px, 43.97px;
                transform: rotate(3turn)
            }}
        }}
    </style>
    <svg id=""logo"" viewBox=""0,0,472,472"" version=""1.1"" xmlns=""http://www.w3.org/2000/svg"" xmlns:svg=""http://www.w3.org/2000/svg""> <defs id=""defs6""> <filter id=""fx0"" x=""-10%"" y=""-10%"" width=""120%"" height=""120%"" filterUnits=""userSpaceOnUse"" primitiveUnits=""userSpaceOnUse""> <feComponentTransfer color-interpolation-filters=""sRGB"" id=""feComponentTransfer1""> <feFuncR type=""discrete"" tableValues=""0.870588 0.870588"" id=""feFuncR1"" /> <feFuncG type=""discrete"" tableValues=""0.360784 0.360784"" id=""feFuncG1"" /> <feFuncB type=""discrete"" tableValues=""0.458824 0.458824"" id=""feFuncB1"" /> <feFuncA type=""linear"" slope=""0.45098"" intercept=""0"" id=""feFuncA1"" /> </feComponentTransfer> <feGaussianBlur stdDeviation=""5.76425 5.77778"" id=""feGaussianBlur1"" /> </filter> <filter id=""fx1"" x=""-10%"" y=""-10%"" width=""120%"" height=""120%"" filterUnits=""userSpaceOnUse"" primitiveUnits=""userSpaceOnUse""> <feComponentTransfer color-interpolation-filters=""sRGB"" id=""feComponentTransfer2""> <feFuncR type=""discrete"" tableValues=""0.933333 0.933333"" id=""feFuncR2"" /> <feFuncG type=""discrete"" tableValues=""0.839216 0.839216"" id=""feFuncG2"" /> <feFuncB type=""discrete"" tableValues=""0.376471 0.376471"" id=""feFuncB2"" /> <feFuncA type=""linear"" slope=""0.509804"" intercept=""0"" id=""feFuncA2"" /> </feComponentTransfer> <feGaussianBlur stdDeviation=""7.55556 7.57205"" id=""feGaussianBlur2"" /> </filter> <filter id=""fx2"" x=""-10%"" y=""-10%"" width=""120%"" height=""120%"" filterUnits=""userSpaceOnUse"" primitiveUnits=""userSpaceOnUse""> <feComponentTransfer color-interpolation-filters=""sRGB"" id=""feComponentTransfer3""> <feFuncR type=""discrete"" tableValues=""0.231373 0.231373"" id=""feFuncR3"" /> <feFuncG type=""discrete"" tableValues=""0.635294 0.635294"" id=""feFuncG3"" /> <feFuncB type=""discrete"" tableValues=""1 1"" id=""feFuncB3"" /> <feFuncA type=""linear"" slope=""0.529412"" intercept=""0"" id=""feFuncA3"" /> </feComponentTransfer> <feGaussianBlur stdDeviation=""7.5735 7.5735"" id=""feGaussianBlur3"" /> </filter> <clipPath id=""clip3""> <rect x=""402"" y=""126"" width=""472"" height=""472"" id=""rect3"" /> </clipPath> <clipPath id=""clip4""> <rect x=""0"" y=""0"" width=""142"" height=""142"" id=""rect4"" /> </clipPath> <clipPath id=""clip5""> <rect x=""0"" y=""0"" width=""153"" height=""153"" id=""rect5"" /> </clipPath> <clipPath id=""clip6""> <rect x=""0"" y=""0"" width=""211"" height=""211"" id=""rect6"" /> </clipPath> </defs> <g clip-path=""url(#clip3)"" transform=""matrix(1.0107296,0,0,1.0107296,-411.36695,-127.45801)"" id=""g13""> <path d=""M 407,235.886 C 407,175.75 455.75,127 515.886,127 H 764.114 C 824.25,127 873,175.75 873,235.886 V 484.114 C 873,544.25 824.25,593 764.114,593 H 515.886 C 455.75,593 407,544.25 407,484.114 Z"" fill-rule=""evenodd"" id=""path6"" /> <g filter=""url(#fx0)"" transform=""matrix(3.00704,0,0,3,443,160)"" id=""g8""> <g clip-path=""url(#clip4)"" id=""g7""> <path d=""m 37.6617,92.2291 c -0.3815,0.139 -1.023,0.365 -1.9246,0.6778 -0.9016,0.3128 -1.9332,0.6691 -3.0949,1.0689 -1.1617,0.3996 -2.3667,0.8081 -3.615,1.2252 -1.2484,0.4171 -2.4274,0.8081 -3.537,1.173 -1.1097,0.365 -2.072,0.6604 -2.8869,0.8864 -0.8149,0.2259 -1.3437,0.3389 -1.5864,0.3389 -0.9363,0 -1.7252,-0.3389 -2.3667,-1.0167 -0.6415,-0.6778 -0.9623,-1.4685 -0.9623,-2.3722 0,-0.2433 0.104,-0.7908 0.3121,-1.6424 0.2081,-0.8516 0.4768,-1.8595 0.8062,-3.0239 0.3295,-1.1644 0.6849,-2.4157 1.0664,-3.7539 0.3814,-1.3381 0.7542,-2.6155 1.1183,-3.8321 0.3641,-1.2165 0.6935,-2.294 0.9882,-3.2324 0.2948,-0.9385 0.4942,-1.5989 0.5982,-1.9813 -3.2596,-6.0131 -4.8894,-12.4086 -4.8894,-19.1864 0,-3.6843 0.4768,-7.2296 1.4304,-10.6359 0.9536,-3.4064 2.2974,-6.5954 4.0312,-9.5672 1.7338,-2.9718 3.8144,-5.6743 6.2418,-8.1073 2.4273,-2.4331 5.1235,-4.5185 8.0883,-6.2565 2.9649,-1.7378 6.1464,-3.0847 9.5448,-4.0406 3.3983,-0.9558 6.9353,-1.4337 10.611,-1.4337 5.5136,0 10.6891,1.0514 15.5264,3.1542 4.8375,2.1029 9.068,4.9704 12.6917,8.6027 3.6237,3.6322 6.4845,7.8727 8.5825,12.7214 2.0979,4.8488 3.1469,10.0364 3.1469,15.5629 0,3.6843 -0.4768,7.2297 -1.4304,10.636 -0.9537,3.4063 -2.2973,6.5953 -4.0312,9.5671 -1.7339,2.9718 -3.8145,5.6743 -6.2418,8.1073 -2.4273,2.4331 -5.1235,4.5185 -8.0883,6.2565 -2.9648,1.7379 -6.1464,3.0847 -9.5448,4.0406 -3.3983,0.9559 -6.9353,1.4338 -10.611,1.4338 -3.5024,0 -6.944,-0.4519 -10.325,-1.3556 -3.381,-0.9037 -6.5972,-2.2419 -9.6487,-4.0146 z M 90.925,57.558 c 0,-4.6228 -0.8669,-8.9589 -2.6008,-13.0082 -1.7338,-4.0492 -4.1092,-7.5859 -7.126,-10.6099 -3.0169,-3.0239 -6.5453,-5.4048 -10.5851,-7.1427 -4.0398,-1.7379 -8.3657,-2.6069 -12.9777,-2.6069 -4.6119,0 -8.9379,0.869 -12.9777,2.6069 -4.0398,1.7379 -7.5682,4.1188 -10.5851,7.1427 -3.0169,3.024 -5.3921,6.5607 -7.126,10.6099 -1.7338,4.0493 -2.6008,8.3854 -2.6008,13.0082 0,3.163 0.4075,6.1001 1.2224,8.8112 0.8149,2.7111 1.9506,5.4569 3.407,8.2376 0.1734,0.2781 0.2947,0.5475 0.3641,0.8082 0.0694,0.2606 0.104,0.5648 0.104,0.9124 0,0.2781 -0.0694,0.7385 -0.2081,1.3816 -0.1386,0.643 -0.3207,1.373 -0.5461,2.1898 -0.2255,0.8167 -0.4768,1.6857 -0.7542,2.6068 -0.2774,0.921 -0.5462,1.8074 -0.8063,2.659 -0.26,0.8516 -0.4941,1.6336 -0.7022,2.3461 -0.208,0.7126 -0.3641,1.2427 -0.4681,1.5902 0.4855,-0.139 1.3177,-0.4257 2.4967,-0.8602 1.179,-0.4345 2.4187,-0.869 3.7191,-1.3035 1.3003,-0.4345 2.5053,-0.8255 3.615,-1.173 1.1097,-0.3476 1.8379,-0.5214 2.1847,-0.5214 0.6588,0 1.283,0.1738 1.8725,0.5214 1.4564,0.8342 2.8782,1.5641 4.2652,2.1897 1.3871,0.6256 2.8002,1.1645 4.2392,1.6163 1.4391,0.4518 2.9215,0.7907 4.4473,1.0166 1.5258,0.226 3.1383,0.3389 4.8374,0.3389 4.612,0 8.9379,-0.8689 12.9777,-2.6068 4.0398,-1.738 7.5682,-4.1188 10.5851,-7.1428 3.0168,-3.024 5.3922,-6.5606 7.126,-10.6099 1.7339,-4.0493 2.6008,-8.3854 2.6008,-13.0082 z M 47.6485,54.2213 c -0.9016,0 -1.6818,-0.3303 -2.3406,-0.9906 -0.6589,-0.6604 -0.9883,-1.4425 -0.9883,-2.3462 0,-0.9038 0.3294,-1.6858 0.9883,-2.3462 0.6588,-0.6603 1.439,-0.9906 2.3406,-0.9906 h 19.9738 c 0.9016,0 1.6818,0.3303 2.3407,0.9906 0.6587,0.6604 0.9882,1.4424 0.9882,2.3462 0,0.9037 -0.3295,1.6858 -0.9882,2.3462 -0.6589,0.6603 -1.4391,0.9906 -2.3407,0.9906 z m 1.6125,49.2697 c 2.7394,0.521 5.531,0.782 8.3744,0.782 3.2249,4.24 7.1347,7.525 11.7294,9.854 4.5947,2.328 9.5621,3.493 14.9023,3.493 1.6991,0 3.3029,-0.113 4.8113,-0.339 1.5085,-0.226 2.9823,-0.556 4.4213,-0.991 1.439,-0.434 2.8608,-0.973 4.2652,-1.616 1.4044,-0.643 2.8351,-1.381 4.2911,-2.216 0.59,-0.347 1.214,-0.521 1.873,-0.521 0.346,0 1.075,0.174 2.184,0.521 1.11,0.348 2.315,0.739 3.615,1.173 1.301,0.435 2.54,0.869 3.719,1.304 1.179,0.434 2.012,0.721 2.497,0.86 -0.104,-0.347 -0.26,-0.878 -0.468,-1.59 -0.208,-0.713 -0.442,-1.495 -0.702,-2.346 -0.26,-0.852 -0.529,-1.738 -0.806,-2.659 -0.278,-0.921 -0.529,-1.79 -0.755,-2.607 -0.225,-0.817 -0.407,-1.547 -0.546,-2.19 -0.138,-0.643 -0.208,-1.103 -0.208,-1.381 0,-0.348 0.035,-0.652 0.104,-0.913 0.07,-0.261 0.191,-0.53 0.364,-0.808 0.728,-1.3903 1.379,-2.7633 1.951,-4.1188 0.572,-1.3556 1.058,-2.7286 1.456,-4.1189 0.399,-1.3902 0.702,-2.8067 0.911,-4.2491 0.208,-1.4425 0.312,-2.9632 0.312,-4.562 0,-2.6069 -0.304,-5.1702 -0.911,-7.6902 -0.606,-2.52 -1.482,-4.927 -2.626,-7.221 -1.145,-2.294 -2.541,-4.4403 -4.188,-6.4389 -1.647,-1.9986 -3.511,-3.78 -5.591,-5.3441 0,-2.7458 -0.243,-5.5439 -0.728,-8.394 3.155,1.7031 6.007,3.806 8.556,6.3086 2.549,2.5025 4.725,5.2658 6.528,8.2897 1.803,3.024 3.191,6.2565 4.161,9.6975 0.971,3.441 1.457,6.9517 1.457,10.5317 0,3.4757 -0.391,6.8213 -1.171,10.0364 -0.78,3.2151 -2.002,6.3521 -3.667,9.4111 0.104,0.382 0.304,1.051 0.598,2.007 0.295,0.956 0.616,2.042 0.963,3.258 0.346,1.217 0.719,2.494 1.118,3.833 0.398,1.338 0.754,2.589 1.066,3.753 0.312,1.165 0.572,2.164 0.78,2.998 0.208,0.834 0.313,1.373 0.313,1.617 0,0.904 -0.321,1.694 -0.963,2.372 -0.642,0.678 -1.43,1.016 -2.366,1.016 -0.243,0 -0.772,-0.112 -1.587,-0.338 -0.815,-0.227 -1.768,-0.522 -2.861,-0.887 -1.092,-0.365 -2.271,-0.756 -3.537,-1.173 -1.265,-0.417 -2.47,-0.825 -3.615,-1.225 -1.144,-0.4 -2.167,-0.756 -3.069,-1.069 -0.901,-0.313 -1.543,-0.539 -1.924,-0.678 -3.26,1.843 -6.5541,3.198 -9.883,4.067 -3.329,0.869 -6.8487,1.303 -10.5591,1.303 -3.5716,0 -7.0654,-0.495 -10.481,-1.485 -3.4156,-0.991 -6.6233,-2.39 -9.6227,-4.197 -2.9995,-1.808 -5.739,-3.998 -8.2184,-6.57 -2.4793,-2.572 -4.5687,-5.422 -6.2678,-8.55 z M 47.6485,67.5683 c -0.9016,0 -1.6818,-0.3302 -2.3406,-0.9906 -0.6589,-0.6603 -0.9883,-1.4424 -0.9883,-2.3462 0,-0.9037 0.3294,-1.6857 0.9883,-2.3461 0.6588,-0.6604 1.439,-0.9906 2.3406,-0.9906 h 13.3159 c 0.9016,0 1.6818,0.3302 2.3406,0.9906 0.6588,0.6604 0.9883,1.4424 0.9883,2.3461 0,0.9038 -0.3295,1.6859 -0.9883,2.3462 -0.6588,0.6604 -1.439,0.9906 -2.3406,0.9906 z"" fill=""#ffffff"" fill-rule=""evenodd"" id=""path7"" /> </g> </g> <path d=""m 544.313,419.609 c -1.114,0.405 -2.987,1.063 -5.619,1.974 -2.632,0.911 -5.644,1.949 -9.035,3.113 -3.392,1.164 -6.91,2.354 -10.555,3.569 -3.644,1.215 -7.086,2.353 -10.326,3.416 -3.239,1.063 -6.049,1.924 -8.428,2.582 -2.379,0.658 -3.923,0.987 -4.631,0.987 -2.734,0 -5.037,-0.987 -6.91,-2.961 -1.873,-1.974 -2.809,-4.277 -2.809,-6.91 0,-0.708 0.304,-2.303 0.911,-4.783 0.608,-2.48 1.392,-5.416 2.354,-8.808 0.962,-3.391 1.999,-7.036 3.113,-10.933 1.114,-3.898 2.202,-7.618 3.265,-11.162 1.063,-3.543 2.025,-6.681 2.885,-9.415 0.861,-2.733 1.443,-4.657 1.746,-5.77 C 490.758,356.994 486,338.366 486,318.625 c 0,-10.731 1.392,-21.057 4.176,-30.979 2.784,-9.921 6.707,-19.209 11.769,-27.865 5.062,-8.656 11.136,-16.527 18.222,-23.614 7.087,-7.086 14.958,-13.16 23.614,-18.222 8.656,-5.062 17.944,-8.985 27.865,-11.769 9.922,-2.784 20.248,-4.176 30.979,-4.176 16.097,0 31.206,3.062 45.329,9.187 14.122,6.125 26.473,14.477 37.053,25.056 10.579,10.58 18.931,22.931 25.056,37.053 6.125,14.123 9.187,29.232 9.187,45.329 0,10.731 -1.392,21.057 -4.176,30.978 -2.784,9.922 -6.707,19.21 -11.769,27.866 -5.062,8.656 -11.136,16.527 -18.222,23.614 -7.087,7.086 -14.958,13.16 -23.614,18.222 -8.656,5.062 -17.944,8.985 -27.866,11.769 -9.921,2.784 -20.247,4.176 -30.978,4.176 -10.225,0 -20.273,-1.316 -30.143,-3.948 -9.871,-2.632 -19.261,-6.53 -28.169,-11.693 z M 699.812,318.625 c 0,-13.464 -2.53,-26.094 -7.592,-37.888 -5.062,-11.794 -11.997,-22.095 -20.804,-30.902 -8.808,-8.808 -19.109,-15.743 -30.903,-20.805 -11.794,-5.062 -24.424,-7.593 -37.888,-7.593 -13.464,0 -26.094,2.531 -37.888,7.593 -11.794,5.062 -22.095,11.997 -30.903,20.805 -8.807,8.807 -15.742,19.108 -20.804,30.902 -5.062,11.794 -7.593,24.424 -7.593,37.888 0,9.212 1.19,17.767 3.569,25.664 2.379,7.896 5.695,15.894 9.947,23.993 0.506,0.81 0.86,1.594 1.063,2.353 0.202,0.76 0.303,1.646 0.303,2.658 0,0.81 -0.202,2.151 -0.607,4.024 -0.405,1.873 -0.936,3.999 -1.595,6.378 -0.658,2.379 -1.391,4.91 -2.201,7.593 -0.81,2.682 -1.595,5.264 -2.354,7.745 -0.76,2.48 -1.443,4.758 -2.05,6.833 -0.608,2.075 -1.063,3.619 -1.367,4.632 1.417,-0.405 3.847,-1.241 7.289,-2.506 3.442,-1.266 7.061,-2.531 10.858,-3.796 3.796,-1.266 7.314,-2.405 10.554,-3.417 3.239,-1.012 5.365,-1.519 6.378,-1.519 1.923,0 3.745,0.507 5.466,1.519 4.252,2.43 8.403,4.555 12.453,6.378 4.049,1.822 8.175,3.391 12.376,4.707 4.201,1.316 8.529,2.303 12.983,2.961 4.455,0.659 9.162,0.987 14.123,0.987 13.464,0 26.094,-2.53 37.888,-7.592 11.794,-5.062 22.095,-11.997 30.903,-20.804 8.807,-8.808 15.742,-19.109 20.804,-30.903 5.062,-11.794 7.592,-24.424 7.592,-37.888 z m -126.343,-9.719 c -2.632,0 -4.91,-0.962 -6.834,-2.885 -1.923,-1.923 -2.885,-4.201 -2.885,-6.833 0,-2.633 0.962,-4.911 2.885,-6.834 1.924,-1.923 4.202,-2.885 6.834,-2.885 h 58.312 c 2.633,0 4.91,0.962 6.834,2.885 1.923,1.923 2.885,4.201 2.885,6.834 0,2.632 -0.962,4.91 -2.885,6.833 -1.924,1.923 -4.201,2.885 -6.834,2.885 z m 4.707,143.504 c 7.998,1.518 16.148,2.278 24.449,2.278 9.415,12.351 20.829,21.917 34.243,28.7 13.414,6.783 27.917,10.174 43.507,10.174 4.96,0 9.643,-0.328 14.047,-0.987 4.403,-0.658 8.706,-1.619 12.907,-2.885 4.202,-1.265 8.352,-2.834 12.453,-4.707 4.1,-1.873 8.276,-4.024 12.528,-6.454 1.721,-1.012 3.543,-1.519 5.466,-1.519 1.013,0 3.139,0.507 6.378,1.519 3.24,1.012 6.758,2.151 10.554,3.417 3.797,1.265 7.416,2.53 10.858,3.796 3.442,1.266 5.872,2.101 7.289,2.506 -0.304,-1.013 -0.759,-2.557 -1.367,-4.632 -0.607,-2.075 -1.29,-4.353 -2.05,-6.834 -0.759,-2.48 -1.544,-5.061 -2.354,-7.744 -0.81,-2.683 -1.543,-5.214 -2.201,-7.593 -0.659,-2.379 -1.19,-4.505 -1.595,-6.378 -0.405,-1.873 -0.607,-3.214 -0.607,-4.024 0,-1.012 0.101,-1.898 0.303,-2.658 0.203,-0.759 0.557,-1.543 1.063,-2.353 2.126,-4.05 4.024,-8.049 5.695,-11.997 1.67,-3.948 3.088,-7.947 4.252,-11.996 1.164,-4.05 2.05,-8.175 2.657,-12.377 0.608,-4.201 0.911,-8.63 0.911,-13.287 0,-7.593 -0.885,-15.059 -2.657,-22.399 -1.771,-7.339 -4.328,-14.35 -7.669,-21.032 -3.34,-6.681 -7.415,-12.933 -12.224,-18.754 -4.809,-5.821 -10.25,-11.009 -16.324,-15.565 0,-7.998 -0.709,-16.147 -2.126,-24.449 9.212,4.961 17.539,11.086 24.98,18.375 7.441,7.289 13.793,15.337 19.058,24.145 5.264,8.807 9.314,18.222 12.148,28.245 2.834,10.022 4.252,20.247 4.252,30.675 0,10.123 -1.139,19.868 -3.417,29.232 -2.278,9.364 -5.846,18.501 -10.706,27.41 0.304,1.114 0.886,3.062 1.747,5.846 0.86,2.784 1.797,5.948 2.809,9.491 1.012,3.544 2.101,7.264 3.265,11.162 1.163,3.897 2.202,7.542 3.113,10.933 0.911,3.392 1.67,6.302 2.278,8.732 0.607,2.43 0.911,3.999 0.911,4.707 0,2.634 -0.935,4.936 -2.809,6.91 -1.874,1.974 -4.176,2.961 -6.91,2.961 -0.708,0 -2.252,-0.328 -4.631,-0.987 -2.379,-0.659 -5.163,-1.519 -8.352,-2.582 -3.189,-1.063 -6.631,-2.201 -10.327,-3.416 -3.695,-1.215 -7.213,-2.405 -10.554,-3.569 -3.34,-1.164 -6.327,-2.202 -8.959,-3.113 -2.632,-0.911 -4.505,-1.569 -5.619,-1.974 -9.516,5.366 -19.133,9.315 -28.852,11.845 -9.719,2.53 -19.994,3.796 -30.827,3.796 -10.427,0 -20.627,-1.443 -30.599,-4.328 -9.971,-2.885 -19.336,-6.96 -28.093,-12.224 -8.757,-5.264 -16.755,-11.642 -23.993,-19.134 -7.238,-7.492 -13.338,-15.793 -18.299,-24.904 z m -4.707,-104.629 c -2.632,0 -4.91,-0.962 -6.834,-2.885 -1.923,-1.923 -2.885,-4.201 -2.885,-6.834 0,-2.632 0.962,-4.91 2.885,-6.833 1.924,-1.923 4.202,-2.885 6.834,-2.885 h 38.875 c 2.632,0 4.91,0.962 6.833,2.885 1.924,1.923 2.885,4.201 2.885,6.833 0,2.633 -0.961,4.911 -2.885,6.834 -1.923,1.923 -4.201,2.885 -6.833,2.885 z"" fill=""#ffffff"" fill-rule=""evenodd"" id=""path8"" /> <g filter=""url(#fx1)"" transform=""matrix(3,0,0,2.99346,402,140)"" id=""g10""> <g clip-path=""url(#clip5)"" id=""g9""> <path d=""m 43.187,97.8462 c -0.3824,0.1393 -1.0253,0.3657 -1.9291,0.6792 -0.9038,0.3135 -1.9377,0.6706 -3.1021,1.0712 -1.1645,0.4005 -2.3723,0.8094 -3.6236,1.2284 -1.2513,0.417 -2.433,0.809 -3.5453,1.175 -1.1123,0.366 -2.0768,0.662 -2.8936,0.888 -0.8168,0.227 -1.3469,0.34 -1.5902,0.34 -0.9384,0 -1.7292,-0.34 -2.3722,-1.019 -0.643,-0.679 -0.9645,-1.472 -0.9645,-2.3773 0,-0.2438 0.1042,-0.7924 0.3128,-1.6459 0.2085,-0.8535 0.4779,-1.8636 0.8081,-3.0305 0.3302,-1.167 0.6865,-2.421 1.0688,-3.7621 0.3823,-1.3411 0.756,-2.6212 1.121,-3.8405 0.3649,-1.2192 0.6951,-2.299 0.9905,-3.2395 0.2955,-0.9405 0.4954,-1.6023 0.5996,-1.9855 C 24.8,76.3014 23.1664,69.8919 23.1664,63.0993 c 0,-3.6923 0.4779,-7.2454 1.4337,-10.6591 0.9559,-3.4138 2.3027,-6.6098 4.0406,-9.5881 1.738,-2.9783 3.8234,-5.6866 6.2565,-8.125 2.433,-2.4384 5.1355,-4.5284 8.1073,-6.2701 2.9718,-1.7417 6.1608,-3.0915 9.5671,-4.0494 3.4063,-0.958 6.9517,-1.4369 10.636,-1.4369 5.5265,0 10.7142,1.0537 15.5629,3.1611 4.8487,2.1075 9.0892,4.9813 12.7214,8.6214 3.6322,3.6402 6.4997,7.8899 8.6031,12.7493 2.102,4.8593 3.154,10.0583 3.154,15.5968 0,3.6924 -0.478,7.2455 -1.434,10.6592 -0.956,3.4138 -2.3026,6.6098 -4.0405,9.5881 -1.738,2.9783 -3.8235,5.6866 -6.2565,8.125 -2.433,2.4383 -5.1355,4.5284 -8.1073,6.2701 -2.9718,1.7417 -6.1608,3.0913 -9.5672,4.0493 -3.4063,0.958 -6.9516,1.437 -10.6359,1.437 -3.5106,0 -6.9603,-0.453 -10.3492,-1.359 -3.3889,-0.905 -6.6128,-2.2463 -9.6714,-4.0228 z M 96.5753,63.0993 c 0,-4.6328 -0.8689,-8.9784 -2.6068,-13.0365 -1.738,-4.0582 -4.1189,-7.6026 -7.1428,-10.6331 -3.024,-3.0306 -6.5606,-5.4166 -10.6099,-7.1584 -4.0493,-1.7417 -8.3854,-2.6125 -13.0082,-2.6125 -4.6228,0 -8.9589,0.8708 -13.0082,2.6125 -4.0493,1.7418 -7.5859,4.1278 -10.6099,7.1584 -3.0239,3.0305 -5.4048,6.5749 -7.1428,10.6331 -1.7379,4.0581 -2.6068,8.4037 -2.6068,13.0365 0,3.1699 0.4084,6.1134 1.2252,8.8304 0.8168,2.7171 1.9552,5.4689 3.415,8.2557 0.1738,0.2787 0.2954,0.5486 0.3649,0.8099 0.0696,0.2612 0.1043,0.566 0.1043,0.9144 0,0.2787 -0.0695,0.7401 -0.2085,1.3846 -0.139,0.6445 -0.3215,1.376 -0.5474,2.1946 -0.226,0.8185 -0.478,1.6894 -0.7561,2.6125 -0.278,0.923 -0.5474,1.8113 -0.8081,2.6648 -0.2607,0.8534 -0.4953,1.6372 -0.7038,2.3513 -0.2086,0.714 -0.365,1.2453 -0.4693,1.5936 0.4867,-0.1393 1.3209,-0.4267 2.5026,-0.8621 1.1817,-0.4355 2.4244,-0.8708 3.7278,-1.3063 1.3034,-0.4354 2.5112,-0.8273 3.6235,-1.1756 1.1123,-0.3483 1.8423,-0.5225 2.1898,-0.5225 0.6603,0 1.286,0.1742 1.8769,0.5225 1.4599,0.836 2.885,1.5675 4.2753,2.1945 1.3903,0.627 2.8067,1.167 4.2491,1.6198 1.4425,0.4528 2.9284,0.7924 4.4577,1.0189 1.5295,0.2264 3.1457,0.3396 4.8488,0.3396 4.6228,0 8.9589,-0.8708 13.0082,-2.6125 4.0493,-1.7418 7.5859,-4.1279 10.6099,-7.1584 3.0239,-3.0306 5.4048,-6.5749 7.1428,-10.6331 1.7379,-4.0581 2.6068,-8.4037 2.6068,-13.0366 z m -43.378,-3.344 c -0.9037,0 -1.6858,-0.331 -2.3462,-0.9928 -0.6603,-0.6618 -0.9906,-1.4455 -0.9906,-2.3513 0,-0.9057 0.3303,-1.6894 0.9906,-2.3513 0.6604,-0.6617 1.4425,-0.9927 2.3462,-0.9927 h 20.0206 c 0.9038,0 1.6858,0.331 2.3462,0.9927 0.6603,0.6619 0.9906,1.4456 0.9906,2.3513 0,0.9058 -0.3303,1.6895 -0.9906,2.3513 -0.6604,0.6618 -1.4424,0.9928 -2.3462,0.9928 z m 1.6162,49.3767 c 2.7459,0.523 5.544,0.784 8.3941,0.784 3.2325,4.25 7.1514,7.542 11.7569,9.876 4.6055,2.333 9.5846,3.5 14.9373,3.5 1.7031,0 3.3107,-0.113 4.8226,-0.339 1.512,-0.227 2.9893,-0.558 4.4317,-0.993 1.4419,-0.435 2.8679,-0.975 4.2749,-1.62 1.408,-0.644 2.842,-1.384 4.302,-2.22 0.591,-0.349 1.216,-0.523 1.877,-0.523 0.347,0 1.077,0.174 2.189,0.523 1.113,0.348 2.32,0.74 3.624,1.175 1.303,0.436 2.546,0.871 3.728,1.306 1.181,0.436 2.016,0.723 2.502,0.863 -0.104,-0.349 -0.26,-0.88 -0.469,-1.594 -0.209,-0.714 -0.443,-1.498 -0.704,-2.351 -0.261,-0.854 -0.53,-1.742 -0.808,-2.665 -0.278,-0.923 -0.53,-1.794 -0.756,-2.613 -0.226,-0.818 -0.408,-1.55 -0.547,-2.194 -0.139,-0.645 -0.209,-1.106 -0.209,-1.385 0,-0.348 0.035,-0.653 0.104,-0.914 0.07,-0.262 0.191,-0.531 0.365,-0.81 0.73,-1.393 1.382,-2.769 1.955,-4.128 0.574,-1.359 1.061,-2.734 1.46,-4.1278 0.4,-1.3933 0.704,-2.8129 0.913,-4.2585 0.208,-1.4455 0.312,-2.9696 0.312,-4.5719 0,-2.6125 -0.304,-5.1815 -0.912,-7.707 -0.608,-2.5255 -1.486,-4.9377 -2.633,-7.2368 -1.147,-2.299 -2.546,-4.4499 -4.197,-6.453 -1.651,-2.0029 -3.519,-3.7881 -5.605,-5.3557 0,-2.7518 -0.243,-5.556 -0.73,-8.4123 3.163,1.7068 6.022,3.8143 8.577,6.3223 2.555,2.5081 4.736,5.2774 6.543,8.3079 1.808,3.0305 3.198,6.2701 4.171,9.7187 0.973,3.4485 1.46,6.9668 1.46,10.5546 0,3.4834 -0.391,6.8362 -1.173,10.0583 -0.782,3.2222 -2.007,6.3662 -3.676,9.4312 0.105,0.383 0.304,1.054 0.6,2.012 0.295,0.958 0.617,2.046 0.964,3.265 0.348,1.22 0.722,2.5 1.121,3.841 0.4,1.341 0.756,2.595 1.069,3.762 0.313,1.167 0.574,2.168 0.782,3.004 0.209,0.836 0.313,1.376 0.313,1.62 0,0.906 -0.321,1.698 -0.965,2.378 -0.643,0.679 -1.433,1.018 -2.372,1.018 -0.243,0 -0.773,-0.112 -1.59,-0.339 -0.817,-0.227 -1.773,-0.523 -2.867,-0.888 -1.095,-0.366 -2.277,-0.758 -3.546,-1.176 -1.269,-0.418 -2.476,-0.827 -3.623,-1.228 -1.147,-0.401 -2.173,-0.758 -3.076,-1.071 -0.904,-0.314 -1.547,-0.54 -1.929,-0.679 -3.268,1.846 -6.57,3.205 -9.907,4.075 -3.3363,0.871 -6.8642,1.306 -10.5833,1.306 -3.5801,0 -7.082,-0.496 -10.5057,-1.489 -3.4236,-0.992 -6.6388,-2.395 -9.6453,-4.206 -3.0065,-1.811 -5.7525,-4.006 -8.2376,-6.583 -2.4852,-2.578 -4.5795,-5.435 -6.2826,-8.57 z M 53.1973,73.1315 c -0.9037,0 -1.6858,-0.3309 -2.3462,-0.9928 -0.6603,-0.6617 -0.9906,-1.4455 -0.9906,-2.3513 0,-0.9056 0.3303,-1.6894 0.9906,-2.3512 0.6604,-0.6618 1.4425,-0.9928 2.3462,-0.9928 h 13.3471 c 0.9037,0 1.6858,0.331 2.3461,0.9928 0.6604,0.6618 0.9906,1.4456 0.9906,2.3512 0,0.9058 -0.3302,1.6896 -0.9906,2.3513 -0.6603,0.6619 -1.4424,0.9928 -2.3461,0.9928 z"" fill=""#ffffff"" fill-rule=""evenodd"" id=""path9"" /> </g> </g> <path d=""m 544.313,419.609 c -1.114,0.405 -2.987,1.063 -5.619,1.974 -2.632,0.911 -5.644,1.949 -9.035,3.113 -3.392,1.164 -6.91,2.354 -10.555,3.569 -3.644,1.215 -7.086,2.353 -10.326,3.416 -3.239,1.063 -6.049,1.924 -8.428,2.582 -2.379,0.658 -3.923,0.987 -4.631,0.987 -2.734,0 -5.037,-0.987 -6.91,-2.961 -1.873,-1.974 -2.809,-4.277 -2.809,-6.91 0,-0.708 0.304,-2.303 0.911,-4.783 0.608,-2.48 1.392,-5.416 2.354,-8.808 0.962,-3.391 1.999,-7.036 3.113,-10.933 1.114,-3.898 2.202,-7.618 3.265,-11.162 1.063,-3.543 2.025,-6.681 2.885,-9.415 0.861,-2.733 1.443,-4.657 1.746,-5.77 C 490.758,356.994 486,338.366 486,318.625 c 0,-10.731 1.392,-21.057 4.176,-30.979 2.784,-9.921 6.707,-19.209 11.769,-27.865 5.062,-8.656 11.136,-16.527 18.222,-23.614 7.087,-7.086 14.958,-13.16 23.614,-18.222 8.656,-5.062 17.944,-8.985 27.865,-11.769 9.922,-2.784 20.248,-4.176 30.979,-4.176 16.097,0 31.206,3.062 45.329,9.187 14.122,6.125 26.473,14.477 37.053,25.056 10.579,10.58 18.931,22.931 25.056,37.053 6.125,14.123 9.187,29.232 9.187,45.329 0,10.731 -1.392,21.057 -4.176,30.978 -2.784,9.922 -6.707,19.21 -11.769,27.866 -5.062,8.656 -11.136,16.527 -18.222,23.614 -7.087,7.086 -14.958,13.16 -23.614,18.222 -8.656,5.062 -17.944,8.985 -27.866,11.769 -9.921,2.784 -20.247,4.176 -30.978,4.176 -10.225,0 -20.273,-1.316 -30.143,-3.948 -9.871,-2.632 -19.261,-6.53 -28.169,-11.693 z M 699.812,318.625 c 0,-13.464 -2.53,-26.094 -7.592,-37.888 -5.062,-11.794 -11.997,-22.095 -20.804,-30.902 -8.808,-8.808 -19.109,-15.743 -30.903,-20.805 -11.794,-5.062 -24.424,-7.593 -37.888,-7.593 -13.464,0 -26.094,2.531 -37.888,7.593 -11.794,5.062 -22.095,11.997 -30.903,20.805 -8.807,8.807 -15.742,19.108 -20.804,30.902 -5.062,11.794 -7.593,24.424 -7.593,37.888 0,9.212 1.19,17.767 3.569,25.664 2.379,7.896 5.695,15.894 9.947,23.993 0.506,0.81 0.86,1.594 1.063,2.353 0.202,0.76 0.303,1.646 0.303,2.658 0,0.81 -0.202,2.151 -0.607,4.024 -0.405,1.873 -0.936,3.999 -1.595,6.378 -0.658,2.379 -1.391,4.91 -2.201,7.593 -0.81,2.682 -1.595,5.264 -2.354,7.745 -0.76,2.48 -1.443,4.758 -2.05,6.833 -0.608,2.075 -1.063,3.619 -1.367,4.632 1.417,-0.405 3.847,-1.241 7.289,-2.506 3.442,-1.266 7.061,-2.531 10.858,-3.796 3.796,-1.266 7.314,-2.405 10.554,-3.417 3.239,-1.012 5.365,-1.519 6.378,-1.519 1.923,0 3.745,0.507 5.466,1.519 4.252,2.43 8.403,4.555 12.453,6.378 4.049,1.822 8.175,3.391 12.376,4.707 4.201,1.316 8.529,2.303 12.983,2.961 4.455,0.659 9.162,0.987 14.123,0.987 13.464,0 26.094,-2.53 37.888,-7.592 11.794,-5.062 22.095,-11.997 30.903,-20.804 8.807,-8.808 15.742,-19.109 20.804,-30.903 5.062,-11.794 7.592,-24.424 7.592,-37.888 z m -126.343,-9.719 c -2.632,0 -4.91,-0.962 -6.834,-2.885 -1.923,-1.923 -2.885,-4.201 -2.885,-6.833 0,-2.633 0.962,-4.911 2.885,-6.834 1.924,-1.923 4.202,-2.885 6.834,-2.885 h 58.312 c 2.633,0 4.91,0.962 6.834,2.885 1.923,1.923 2.885,4.201 2.885,6.834 0,2.632 -0.962,4.91 -2.885,6.833 -1.924,1.923 -4.201,2.885 -6.834,2.885 z m 4.707,143.504 c 7.998,1.518 16.148,2.278 24.449,2.278 9.415,12.351 20.829,21.917 34.243,28.7 13.414,6.783 27.917,10.174 43.507,10.174 4.96,0 9.643,-0.328 14.047,-0.987 4.403,-0.658 8.706,-1.619 12.907,-2.885 4.202,-1.265 8.352,-2.834 12.453,-4.707 4.1,-1.873 8.276,-4.024 12.528,-6.454 1.721,-1.012 3.543,-1.519 5.466,-1.519 1.013,0 3.139,0.507 6.378,1.519 3.24,1.012 6.758,2.151 10.554,3.417 3.797,1.265 7.416,2.53 10.858,3.796 3.442,1.266 5.872,2.101 7.289,2.506 -0.304,-1.013 -0.759,-2.557 -1.367,-4.632 -0.607,-2.075 -1.29,-4.353 -2.05,-6.834 -0.759,-2.48 -1.544,-5.061 -2.354,-7.744 -0.81,-2.683 -1.543,-5.214 -2.201,-7.593 -0.659,-2.379 -1.19,-4.505 -1.595,-6.378 -0.405,-1.873 -0.607,-3.214 -0.607,-4.024 0,-1.012 0.101,-1.898 0.303,-2.658 0.203,-0.759 0.557,-1.543 1.063,-2.353 2.126,-4.05 4.024,-8.049 5.695,-11.997 1.67,-3.948 3.088,-7.947 4.252,-11.996 1.164,-4.05 2.05,-8.175 2.657,-12.377 0.608,-4.201 0.911,-8.63 0.911,-13.287 0,-7.593 -0.885,-15.059 -2.657,-22.399 -1.771,-7.339 -4.328,-14.35 -7.669,-21.032 -3.34,-6.681 -7.415,-12.933 -12.224,-18.754 -4.809,-5.821 -10.25,-11.009 -16.324,-15.565 0,-7.998 -0.709,-16.147 -2.126,-24.449 9.212,4.961 17.539,11.086 24.98,18.375 7.441,7.289 13.793,15.337 19.058,24.145 5.264,8.807 9.314,18.222 12.148,28.245 2.834,10.022 4.252,20.247 4.252,30.675 0,10.123 -1.139,19.868 -3.417,29.232 -2.278,9.364 -5.846,18.501 -10.706,27.41 0.304,1.114 0.886,3.062 1.747,5.846 0.86,2.784 1.797,5.948 2.809,9.491 1.012,3.544 2.101,7.264 3.265,11.162 1.163,3.897 2.202,7.542 3.113,10.933 0.911,3.392 1.67,6.302 2.278,8.732 0.607,2.43 0.911,3.999 0.911,4.707 0,2.634 -0.935,4.936 -2.809,6.91 -1.874,1.974 -4.176,2.961 -6.91,2.961 -0.708,0 -2.252,-0.328 -4.631,-0.987 -2.379,-0.659 -5.163,-1.519 -8.352,-2.582 -3.189,-1.063 -6.631,-2.201 -10.327,-3.416 -3.695,-1.215 -7.213,-2.405 -10.554,-3.569 -3.34,-1.164 -6.327,-2.202 -8.959,-3.113 -2.632,-0.911 -4.505,-1.569 -5.619,-1.974 -9.516,5.366 -19.133,9.315 -28.852,11.845 -9.719,2.53 -19.994,3.796 -30.827,3.796 -10.427,0 -20.627,-1.443 -30.599,-4.328 -9.971,-2.885 -19.336,-6.96 -28.093,-12.224 -8.757,-5.264 -16.755,-11.642 -23.993,-19.134 -7.238,-7.492 -13.338,-15.793 -18.299,-24.904 z m -4.707,-104.629 c -2.632,0 -4.91,-0.962 -6.834,-2.885 -1.923,-1.923 -2.885,-4.201 -2.885,-6.834 0,-2.632 0.962,-4.91 2.885,-6.833 1.924,-1.923 4.202,-2.885 6.834,-2.885 h 38.875 c 2.632,0 4.91,0.962 6.833,2.885 1.924,1.923 2.885,4.201 2.885,6.833 0,2.633 -0.961,4.911 -2.885,6.834 -1.923,1.923 -4.201,2.885 -6.833,2.885 z"" fill=""#ffffff"" fill-rule=""evenodd"" id=""path10"" /> <g filter=""url(#fx2)"" transform=""matrix(1.99526,0,0,1.99526,445,140)"" id=""g12""> <g clip-path=""url(#clip6)"" id=""g11""> <path d=""m 54.2395,138.155 c -0.5861,0.213 -1.5716,0.559 -2.9569,1.038 -1.3852,0.48 -2.97,1.026 -4.7548,1.639 -1.7848,0.612 -3.6361,1.238 -5.554,1.878 -1.9179,0.639 -3.7293,1.238 -5.4341,1.798 -1.7048,0.559 -3.1833,1.012 -4.4352,1.358 -1.252,0.347 -2.0644,0.52 -2.4373,0.52 -1.4385,0 -2.6505,-0.52 -3.6361,-1.559 -0.9856,-1.039 -1.4784,-2.251 -1.4784,-3.636 0,-0.373 0.1598,-1.212 0.4794,-2.517 0.3197,-1.305 0.7326,-2.85 1.2387,-4.635 0.5061,-1.785 1.0522,-3.703 1.6383,-5.754 0.586,-2.051 1.1587,-4.009 1.7181,-5.873 0.5594,-1.865 1.0655,-3.517 1.5183,-4.955 0.4528,-1.438 0.7592,-2.451 0.9191,-3.037 -5.008,-9.217 -7.5119,-19.0192 -7.5119,-29.4079 0,-5.6472 0.7325,-11.0813 2.1976,-16.3023 1.4651,-5.2211 3.5295,-10.1091 6.1933,-14.6642 2.6638,-4.5551 5.8603,-8.6973 9.5896,-12.4265 3.7292,-3.7293 7.8715,-6.9258 12.4265,-9.5897 4.5551,-2.6637 9.4431,-4.7281 14.6642,-6.1932 5.221,-1.4651 10.6552,-2.1977 16.3023,-2.1977 8.4708,0 16.4218,1.6116 23.8538,4.8348 7.432,3.2232 13.932,7.6184 19.499,13.1857 5.568,5.5673 9.963,12.067 13.186,19.4989 3.223,7.432 4.835,15.3834 4.835,23.8542 0,5.6472 -0.733,11.0813 -2.198,16.3019 -1.465,5.222 -3.529,10.11 -6.193,14.665 -2.664,4.555 -5.861,8.697 -9.59,12.426 -3.729,3.729 -7.871,6.926 -12.426,9.59 -4.555,2.664 -9.443,4.728 -14.664,6.193 -5.2215,1.465 -10.6556,2.198 -16.3028,2.198 -5.3809,0 -10.6684,-0.693 -15.8628,-2.078 -5.1944,-1.385 -10.1357,-3.436 -14.8239,-6.153 z M 136.071,85.0121 c 0,-7.0856 -1.332,-13.7319 -3.996,-19.9384 -2.664,-6.2066 -6.313,-11.6274 -10.948,-16.2624 -4.635,-4.635 -10.056,-8.2843 -16.262,-10.9482 -6.2069,-2.6637 -12.8531,-3.9956 -19.9388,-3.9956 -7.0855,0 -13.7318,1.3319 -19.9384,3.9956 -6.2065,2.6639 -11.6274,6.3132 -16.2624,10.9482 -4.635,4.635 -8.2843,10.0558 -10.9481,16.2624 -2.6638,6.2065 -3.9957,12.8528 -3.9957,19.9384 0,4.8481 0.626,9.3499 1.878,13.5054 1.252,4.1555 2.9967,8.3645 5.2343,12.6265 0.2664,0.426 0.4528,0.839 0.5594,1.238 0.1066,0.4 0.1598,0.866 0.1598,1.399 0,0.426 -0.1066,1.132 -0.3196,2.118 -0.2131,0.985 -0.4928,2.104 -0.8391,3.356 -0.3464,1.252 -0.7325,2.584 -1.1588,3.996 -0.4262,1.411 -0.839,2.77 -1.2387,4.075 -0.3995,1.306 -0.7591,2.504 -1.0788,3.596 -0.3196,1.092 -0.5593,1.905 -0.7192,2.438 0.7459,-0.213 2.0245,-0.653 3.8358,-1.319 1.8114,-0.666 3.716,-1.332 5.7139,-1.998 1.9978,-0.666 3.8491,-1.265 5.554,-1.798 1.7048,-0.532 2.8237,-0.799 3.3563,-0.799 1.0122,0 1.9712,0.267 2.8769,0.799 2.2376,1.279 4.422,2.398 6.553,3.357 2.1309,0.959 4.302,1.784 6.5129,2.477 2.2109,0.692 4.4884,1.212 6.8326,1.558 2.3442,0.347 4.8215,0.52 7.4319,0.52 7.0857,0 13.7319,-1.332 19.9388,-3.996 6.206,-2.664 11.627,-6.313 16.262,-10.948 4.635,-4.635 8.284,-10.056 10.948,-16.262 2.664,-6.2071 3.996,-12.8533 3.996,-19.9389 z M 69.5828,79.8977 c -1.3852,0 -2.5839,-0.5063 -3.596,-1.5184 -1.0123,-1.0122 -1.5184,-2.2109 -1.5184,-3.5961 0,-1.3853 0.5061,-2.5839 1.5184,-3.5961 1.0121,-1.0122 2.2108,-1.5184 3.596,-1.5184 H 100.27 c 1.385,0 2.584,0.5062 3.596,1.5184 1.012,1.0122 1.518,2.2108 1.518,3.5961 0,1.3852 -0.506,2.5839 -1.518,3.5961 -1.012,1.0121 -2.211,1.5184 -3.596,1.5184 z m 2.4774,75.5183 c 4.2087,0.799 8.4975,1.199 12.866,1.199 4.9547,6.499 10.9615,11.534 18.0208,15.103 7.059,3.57 14.691,5.354 22.895,5.354 2.61,0 5.074,-0.173 7.392,-0.519 2.317,-0.346 4.582,-0.852 6.793,-1.518 2.21,-0.666 4.395,-1.492 6.553,-2.478 2.157,-0.985 4.355,-2.117 6.592,-3.396 0.906,-0.533 1.865,-0.799 2.877,-0.799 0.533,0 1.652,0.266 3.357,0.799 1.704,0.533 3.556,1.132 5.554,1.798 1.997,0.666 3.902,1.332 5.713,1.998 1.812,0.666 3.09,1.105 3.836,1.318 -0.16,-0.532 -0.399,-1.345 -0.719,-2.437 -0.32,-1.092 -0.679,-2.291 -1.079,-3.596 -0.399,-1.305 -0.812,-2.664 -1.238,-4.076 -0.427,-1.411 -0.813,-2.743 -1.159,-3.995 -0.347,-1.252 -0.626,-2.371 -0.839,-3.357 -0.213,-0.985 -0.32,-1.691 -0.32,-2.117 0,-0.533 0.053,-0.999 0.16,-1.399 0.106,-0.399 0.293,-0.812 0.559,-1.238 1.119,-2.131 2.118,-4.236 2.997,-6.314 0.879,-2.077 1.625,-4.182 2.238,-6.313 0.612,-2.131 1.078,-4.302 1.398,-6.513 0.32,-2.211 0.48,-4.542 0.48,-6.992 0,-3.996 -0.467,-7.925 -1.399,-11.787 -0.932,-3.863 -2.277,-7.552 -4.036,-11.068 -1.758,-3.5166 -3.902,-6.8064 -6.433,-9.8698 -2.53,-3.0634 -5.394,-5.7937 -8.59,-8.1911 0,-4.2087 -0.373,-8.4975 -1.119,-12.8661 4.848,2.6105 9.23,5.8337 13.146,9.6696 3.915,3.8358 7.259,8.0712 10.029,12.7062 2.77,4.635 4.902,9.5892 6.393,14.8642 1.491,5.274 2.237,10.655 2.237,16.142 0,5.328 -0.599,10.456 -1.798,15.384 -1.198,4.928 -3.076,9.736 -5.633,14.424 0.159,0.586 0.466,1.612 0.919,3.077 0.452,1.465 0.945,3.13 1.478,4.994 0.533,1.865 1.105,3.823 1.718,5.874 0.612,2.051 1.159,3.969 1.638,5.754 0.48,1.784 0.879,3.316 1.199,4.595 0.32,1.278 0.479,2.104 0.479,2.477 0,1.386 -0.492,2.597 -1.478,3.636 -0.986,1.039 -2.198,1.558 -3.636,1.558 -0.373,0 -1.185,-0.172 -2.437,-0.519 -1.252,-0.347 -2.717,-0.799 -4.396,-1.359 -1.678,-0.559 -3.489,-1.158 -5.434,-1.798 -1.944,-0.639 -3.796,-1.265 -5.554,-1.878 -1.758,-0.612 -3.329,-1.158 -4.715,-1.638 -1.385,-0.479 -2.37,-0.826 -2.956,-1.039 -5.008,2.824 -10.069,4.902 -15.184,6.234 -5.114,1.331 -10.522,1.997 -16.222,1.997 -5.488,0 -10.855,-0.759 -16.103,-2.277 -5.248,-1.519 -10.1757,-3.663 -14.7839,-6.433 -4.6083,-2.771 -8.8172,-6.127 -12.6263,-10.069 -3.8092,-3.943 -7.0192,-8.311 -9.6296,-13.106 z m -2.4774,-55.061 c -1.3852,0 -2.5839,-0.5057 -3.596,-1.5179 -1.0123,-1.0121 -1.5184,-2.2108 -1.5184,-3.5961 0,-1.3852 0.5061,-2.5839 1.5184,-3.596 1.0121,-1.0123 2.2108,-1.5184 3.596,-1.5184 h 20.4579 c 1.3852,0 2.5839,0.5061 3.5961,1.5184 1.0122,1.0121 1.5183,2.2108 1.5183,3.596 0,1.3853 -0.5061,2.584 -1.5183,3.5961 -1.0122,1.0122 -2.2109,1.5179 -3.5961,1.5179 z"" fill=""#ffffff"" fill-rule=""evenodd"" id=""path11"" /> </g> </g> <path d=""m 544.313,419.609 c -1.114,0.405 -2.987,1.063 -5.619,1.974 -2.632,0.911 -5.644,1.949 -9.035,3.113 -3.392,1.164 -6.91,2.354 -10.555,3.569 -3.644,1.215 -7.086,2.353 -10.326,3.416 -3.239,1.063 -6.049,1.924 -8.428,2.582 -2.379,0.658 -3.923,0.987 -4.631,0.987 -2.734,0 -5.037,-0.987 -6.91,-2.961 -1.873,-1.974 -2.809,-4.277 -2.809,-6.91 0,-0.708 0.304,-2.303 0.911,-4.783 0.608,-2.48 1.392,-5.416 2.354,-8.808 0.962,-3.391 1.999,-7.036 3.113,-10.933 1.114,-3.898 2.202,-7.618 3.265,-11.162 1.063,-3.543 2.025,-6.681 2.885,-9.415 0.861,-2.733 1.443,-4.657 1.746,-5.77 C 490.758,356.994 486,338.366 486,318.625 c 0,-10.731 1.392,-21.057 4.176,-30.979 2.784,-9.921 6.707,-19.209 11.769,-27.865 5.062,-8.656 11.136,-16.527 18.222,-23.614 7.087,-7.086 14.958,-13.16 23.614,-18.222 8.656,-5.062 17.944,-8.985 27.865,-11.769 9.922,-2.784 20.248,-4.176 30.979,-4.176 16.097,0 31.206,3.062 45.329,9.187 14.122,6.125 26.473,14.477 37.053,25.056 10.579,10.58 18.931,22.931 25.056,37.053 6.125,14.123 9.187,29.232 9.187,45.329 0,10.731 -1.392,21.057 -4.176,30.978 -2.784,9.922 -6.707,19.21 -11.769,27.866 -5.062,8.656 -11.136,16.527 -18.222,23.614 -7.087,7.086 -14.958,13.16 -23.614,18.222 -8.656,5.062 -17.944,8.985 -27.866,11.769 -9.921,2.784 -20.247,4.176 -30.978,4.176 -10.225,0 -20.273,-1.316 -30.143,-3.948 -9.871,-2.632 -19.261,-6.53 -28.169,-11.693 z M 699.812,318.625 c 0,-13.464 -2.53,-26.094 -7.592,-37.888 -5.062,-11.794 -11.997,-22.095 -20.804,-30.902 -8.808,-8.808 -19.109,-15.743 -30.903,-20.805 -11.794,-5.062 -24.424,-7.593 -37.888,-7.593 -13.464,0 -26.094,2.531 -37.888,7.593 -11.794,5.062 -22.095,11.997 -30.903,20.805 -8.807,8.807 -15.742,19.108 -20.804,30.902 -5.062,11.794 -7.593,24.424 -7.593,37.888 0,9.212 1.19,17.767 3.569,25.664 2.379,7.896 5.695,15.894 9.947,23.993 0.506,0.81 0.86,1.594 1.063,2.353 0.202,0.76 0.303,1.646 0.303,2.658 0,0.81 -0.202,2.151 -0.607,4.024 -0.405,1.873 -0.936,3.999 -1.595,6.378 -0.658,2.379 -1.391,4.91 -2.201,7.593 -0.81,2.682 -1.595,5.264 -2.354,7.745 -0.76,2.48 -1.443,4.758 -2.05,6.833 -0.608,2.075 -1.063,3.619 -1.367,4.632 1.417,-0.405 3.847,-1.241 7.289,-2.506 3.442,-1.266 7.061,-2.531 10.858,-3.796 3.796,-1.266 7.314,-2.405 10.554,-3.417 3.239,-1.012 5.365,-1.519 6.378,-1.519 1.923,0 3.745,0.507 5.466,1.519 4.252,2.43 8.403,4.555 12.453,6.378 4.049,1.822 8.175,3.391 12.376,4.707 4.201,1.316 8.529,2.303 12.983,2.961 4.455,0.659 9.162,0.987 14.123,0.987 13.464,0 26.094,-2.53 37.888,-7.592 11.794,-5.062 22.095,-11.997 30.903,-20.804 8.807,-8.808 15.742,-19.109 20.804,-30.903 5.062,-11.794 7.592,-24.424 7.592,-37.888 z m -126.343,-9.719 c -2.632,0 -4.91,-0.962 -6.834,-2.885 -1.923,-1.923 -2.885,-4.201 -2.885,-6.833 0,-2.633 0.962,-4.911 2.885,-6.834 1.924,-1.923 4.202,-2.885 6.834,-2.885 h 58.312 c 2.633,0 4.91,0.962 6.834,2.885 1.923,1.923 2.885,4.201 2.885,6.834 0,2.632 -0.962,4.91 -2.885,6.833 -1.924,1.923 -4.201,2.885 -6.834,2.885 z m 4.707,143.504 c 7.998,1.518 16.148,2.278 24.449,2.278 9.415,12.351 20.829,21.917 34.243,28.7 13.414,6.783 27.917,10.174 43.507,10.174 4.96,0 9.643,-0.328 14.047,-0.987 4.403,-0.658 8.706,-1.619 12.907,-2.885 4.202,-1.265 8.352,-2.834 12.453,-4.707 4.1,-1.873 8.276,-4.024 12.528,-6.454 1.721,-1.012 3.543,-1.519 5.466,-1.519 1.013,0 3.139,0.507 6.378,1.519 3.24,1.012 6.758,2.151 10.554,3.417 3.797,1.265 7.416,2.53 10.858,3.796 3.442,1.266 5.872,2.101 7.289,2.506 -0.304,-1.013 -0.759,-2.557 -1.367,-4.632 -0.607,-2.075 -1.29,-4.353 -2.05,-6.834 -0.759,-2.48 -1.544,-5.061 -2.354,-7.744 -0.81,-2.683 -1.543,-5.214 -2.201,-7.593 -0.659,-2.379 -1.19,-4.505 -1.595,-6.378 -0.405,-1.873 -0.607,-3.214 -0.607,-4.024 0,-1.012 0.101,-1.898 0.303,-2.658 0.203,-0.759 0.557,-1.543 1.063,-2.353 2.126,-4.05 4.024,-8.049 5.695,-11.997 1.67,-3.948 3.088,-7.947 4.252,-11.996 1.164,-4.05 2.05,-8.175 2.657,-12.377 0.608,-4.201 0.911,-8.63 0.911,-13.287 0,-7.593 -0.885,-15.059 -2.657,-22.399 -1.771,-7.339 -4.328,-14.35 -7.669,-21.032 -3.34,-6.681 -7.415,-12.933 -12.224,-18.754 -4.809,-5.821 -10.25,-11.009 -16.324,-15.565 0,-7.998 -0.709,-16.147 -2.126,-24.449 9.212,4.961 17.539,11.086 24.98,18.375 7.441,7.289 13.793,15.337 19.058,24.145 5.264,8.807 9.314,18.222 12.148,28.245 2.834,10.022 4.252,20.247 4.252,30.675 0,10.123 -1.139,19.868 -3.417,29.232 -2.278,9.364 -5.846,18.501 -10.706,27.41 0.304,1.114 0.886,3.062 1.747,5.846 0.86,2.784 1.797,5.948 2.809,9.491 1.012,3.544 2.101,7.264 3.265,11.162 1.163,3.897 2.202,7.542 3.113,10.933 0.911,3.392 1.67,6.302 2.278,8.732 0.607,2.43 0.911,3.999 0.911,4.707 0,2.634 -0.935,4.936 -2.809,6.91 -1.874,1.974 -4.176,2.961 -6.91,2.961 -0.708,0 -2.252,-0.328 -4.631,-0.987 -2.379,-0.659 -5.163,-1.519 -8.352,-2.582 -3.189,-1.063 -6.631,-2.201 -10.327,-3.416 -3.695,-1.215 -7.213,-2.405 -10.554,-3.569 -3.34,-1.164 -6.327,-2.202 -8.959,-3.113 -2.632,-0.911 -4.505,-1.569 -5.619,-1.974 -9.516,5.366 -19.133,9.315 -28.852,11.845 -9.719,2.53 -19.994,3.796 -30.827,3.796 -10.427,0 -20.627,-1.443 -30.599,-4.328 -9.971,-2.885 -19.336,-6.96 -28.093,-12.224 -8.757,-5.264 -16.755,-11.642 -23.993,-19.134 -7.238,-7.492 -13.338,-15.793 -18.299,-24.904 z m -4.707,-104.629 c -2.632,0 -4.91,-0.962 -6.834,-2.885 -1.923,-1.923 -2.885,-4.201 -2.885,-6.834 0,-2.632 0.962,-4.91 2.885,-6.833 1.924,-1.923 4.202,-2.885 6.834,-2.885 h 38.875 c 2.632,0 4.91,0.962 6.833,2.885 1.924,1.923 2.885,4.201 2.885,6.833 0,2.633 -0.961,4.911 -2.885,6.834 -1.923,1.923 -4.201,2.885 -6.833,2.885 z"" fill=""#ffffff"" fill-rule=""evenodd"" id=""path12"" /> </g></svg>
    <span id=""caph"">Caph</span>
    <loading><svg width=""40px"" height=""40px"" viewBox=""0 0 16 16""><circle cx=""8px"" cy=""8px"" r=""6px""></circle></svg></loading>
    <div id=""tip"" style=""color: var(--text);opacity: 0.7;visibility: hidden;display: flex;flex-direction: column;align-items: center;"">
        <span style=""font-size:19px;"">服务端进程似乎无法启动</span>
        <span style=""font-size:15px;margin-top: 5px;text-align: center;"">服务端可能出现代码错误，导致运行停止。尝试在浏览器中访问 http://localhost:777 检查问题。</span>
    </div>
    <script>
        (function poll() {{
            fetch('http://localhost:777/isready?' + Date.now(), {{ cache: 'no-store' }})
                .then(response => response.text())
                .then(text => {{
                    if (text.trim() === 'well') {{
                        window.location.href = 'http://localhost:777/';
                    }} else {{
                        setTimeout(poll, 1000);
                    }}
                }})
                .catch(err => {{setTimeout(poll, 1000);}});
        }})();
        setTimeout(()=>{{
            document.getElementById('tip').style.visibility='visible';
        }}, 10000);
    </script>
</body>
</html>");
        }


        //private void Cefb_FrameLoadEnd(object sender, FrameLoadEndEventArgs e)
        //{
        //    throw new NotImplementedException();
        //}

        // 事件处理方法
        private void Browser_LoadError(object sender, CefSharp.LoadErrorEventArgs e)
        {
            // 排除中断导航的特殊情况（比如用户取消）
            if (e.ErrorCode == CefErrorCode.Aborted)
                return;
            string errorHtml = $@"
            <html>
            <head>
                <meta charset='UTF-8'>
                <!--meta http-equiv='refresh' content='3;url={e.FailedUrl}'-->
            </head>
            <body style='font-family:sans-serif;padding-top:50px;display:flex;flex-direction:column;align-items:center;user-select: none;transition:100ms;'>
                <style>.btn{{
                    padding: 7px 18px;
                    font-size: 15px;
                    border-radius: 8px;
                    cursor: default;
                    user-select: none;
                    width: max-content;
                    transition: 100ms;
                }}
                .btn.p{{
                    background-color: #61ccff;
                    color: #000;
                }}
                .btn:hover{{
                    background-color: #ffffff20;
                }}
                .btn.p:hover{{
                    background-color: #7ed6ff;
                }}
                .btn:active{{
                    opacity: 0.6;
                }}
                @media (prefers-color-scheme: dark){{
                    body{{
                        color:#fff;
                    }}
                    .detail{{
                        color:#999 !important;
                    }}
                }}
                </style>
                <h1>连接错误</h1>
                <span>请尝试重启 Caph。</span>
                <p style='user-select: text;'>{e.ErrorCode}: {e.ErrorText}</p>
                <div style='display:flex;gap:10px;'>
                    <div class='btn p' onclick='document.body.style.opacity=0;window.location.href=""{e.FailedUrl}"";'>刷新</div>
                    <div class=btn onclick='window.cefBridge.openDevTools();'>打开 Devtools</div>
                </div>
            </body>
            </html>";
            e.Frame.LoadHtml(errorHtml);
        }

        private void handle_ThemeChanged(object sender, EventArgs e)
        {
            bool isLight = IsLightTheme();
            if (isLight)
            {
                // #ffffff
                //header.Background = new SolidColorBrush(Colors.White);
            }
            else
            {
                // #222222
                //header.Background = new SolidColorBrush(Color.FromRgb(34, 34, 34));
            }
        }

        public static bool IsLightTheme()
        {
            const string keyPath = @"Software\Microsoft\Windows\CurrentVersion\Themes\Personalize";
            const string valueName = "AppsUseLightTheme";

            using (RegistryKey key = Registry.CurrentUser.OpenSubKey(keyPath))
            {
                if (key != null)
                {
                    object registryValueObject = key.GetValue(valueName);
                    if (registryValueObject != null)
                    {
                        int registryValue = (int)registryValueObject;
                        return registryValue > 0;
                    }
                }
            }
            // 默认浅色主题
            return true;
        }
        private void MainWindow_SourceInitialized(object sender, EventArgs e)
        {
            _trayIcon.Icon = new System.Drawing.Icon(Assembly.GetExecutingAssembly().GetManifestResourceStream(IsLightTheme() ? "Webapp.icolight.ico" : "Webapp.ico.ico"));
        }

        private void MainWindow_Loaded(object sender, RoutedEventArgs e)
        {
            // compute vertical size and position (Top and Height), but do not set Left here
            UpdateVerticalSizeAndTop();

            // lock height as fixed as well
            this.MinHeight = this.MaxHeight = this.Height;

            ComputeVisibleHiddenLeft(out double visibleLeft, out double hiddenLeft);
            this.Left = hiddenLeft;
            // ensure Topmost
            this.Topmost = true;
            AnimateHide(false);
        }

        private void UpdateVerticalSizeAndTop()
        {
            var screen = Screen.FromHandle(new WindowInteropHelper(this).Handle);
            var workingArea = screen.WorkingArea; // excludes taskbar

            // convert workingArea (pixels) to device independent units (WPF units)
            double dpiX = 96.0, dpiY = 96.0;
            var source = PresentationSource.FromVisual(this);
            if (source != null)
            {
                dpiX = 96.0 * source.CompositionTarget.TransformToDevice.M11;
                dpiY = 96.0 * source.CompositionTarget.TransformToDevice.M22;
            }

            double scaleX = dpiX / 96.0;

            // Set height to workingArea minus top and bottom margins
            this.Height = (workingArea.Height / scaleX) - TopMargin - BottomMargin;
            this.Top = (workingArea.Top / scaleX) + TopMargin;

            // Do NOT set Left here; Left will be controlled by animation logic to avoid flash
        }

        private void ComputeVisibleHiddenLeft(out double visibleLeft, out double hiddenLeft)
        {
            var screen = Screen.FromHandle(new WindowInteropHelper(this).Handle);
            var workingArea = screen.WorkingArea;

            double dpiX = 96.0;
            var source = PresentationSource.FromVisual(this);
            if (source != null)
            {
                dpiX = 96.0 * source.CompositionTarget.TransformToDevice.M11;
            }
            double scaleX = dpiX / 96.0;

            visibleLeft = (workingArea.Right / scaleX) - RightMargin - this.Width;
            hiddenLeft = (workingArea.Right / scaleX) + 10; // off-screen to right
        }

        // Use per-frame updates to move actual window position for smooth animation including HWND children (WebView2)
        public void AnimateHide(bool hide)
        {
            if (_isAnimating) return;

            ComputeVisibleHiddenLeft(out double visibleLeft, out double hiddenLeft);

            _animFrom = hide ? visibleLeft : hiddenLeft;
            _animTo = hide ? hiddenLeft : visibleLeft;

            // choose easing: hide = ease-in (smooth start), show = ease-out (smooth end)
            IEasingFunction easing = hide ? (IEasingFunction)new QuadraticEase { EasingMode = EasingMode.EaseIn } : new QuadraticEase { EasingMode = EasingMode.EaseOut };

            _animWatch = Stopwatch.StartNew();
            _isAnimating = true;

            // if showing ensure window placed off-screen before showing
            if (!hide)
            {
                this.Left = _animFrom; // start outside
                this.Show();
            }

            CompositionTarget.Rendering += OnRenderingAnimate;

            void OnRenderingAnimate(object s, EventArgs ev)
            {
                double elapsed = _animWatch.Elapsed.TotalMilliseconds;
                double t = Math.Min(1.0, elapsed / _animDurationMs);
                double eased = (easing != null) ? easing.Ease(t) : t;
                double value = _animFrom + (_animTo - _animFrom) * eased;

                // set actual window left so WebView2 moves smoothly
                this.Left = value;

                if (t >= 1.0)
                {
                    CompositionTarget.Rendering -= OnRenderingAnimate;
                    _animWatch.Stop();
                    _isAnimating = false;
                    _isHidden = hide;
                    if (_isHidden)
                        this.Hide();
                    else
                        this.Show();
                }
            }
        }

        private void HideButton_Click(object sender, RoutedEventArgs e)
        {
            if (_isHidden) return;
            AnimateHide(true);
        }

        private void InitTray()
        {
            _trayIcon = new NotifyIcon();
            _trayIcon.Icon = System.Drawing.SystemIcons.Application;
            _trayIcon.Visible = true;
            _trayIcon.Text = "Caph";

            var context = new System.Windows.Forms.ContextMenuStrip();
            var exitItem = new ToolStripMenuItem("退出");
            exitItem.Click += (s, e) => { _trayIcon.Visible = false; System.Windows.Application.Current.Shutdown(); };
            context.Items.Add(exitItem);
            _trayIcon.ContextMenuStrip = context;

            _trayIcon.MouseClick += TrayIcon_MouseClick;
        }

        private void TrayIcon_MouseClick(object sender, System.Windows.Forms.MouseEventArgs e)
        {
            if (e.Button == MouseButtons.Left)
            {
                ToggleShowFromTray();
            }
        }

        private void ToggleShowFromTray()
        {
            if (_isHidden || !this.IsVisible)
            {
                // update vertical position/size only (do not set Left to avoid flash)
                UpdateVerticalSizeAndTop();
                // ensure height locked
                this.MinHeight = this.MaxHeight = this.Height;
                // compute off-screen left and set before showing in animation
                ComputeVisibleHiddenLeft(out double visibleLeft, out double hiddenLeft);
                this.Left = hiddenLeft;

                AnimateHide(false);
                this.Activate();
            }
            else
            {
                AnimateHide(true);
            }
        }
        protected override void OnClosed(EventArgs e)
        {
            base.OnClosed(e);
            if (_childProcess != null && !_childProcess.HasExited)
            {
                try
                {
                    _childProcess.Kill();
                    _childProcess.Dispose();
                }
                catch
                {
                    // 可能已经退出
                }
            }
            if (_trayIcon != null)
            {
                _trayIcon.Visible = false;
                _trayIcon.Dispose();
                _trayIcon = null;
            }
        }
    }
}
